<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>变分下界ELBO与KL散度可视化演示</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif; background: #f8f9fa; margin: 0; padding: 20px; color: #343a40; }
    .container { max-width: 800px; margin: 20px auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); padding: 32px; }
    h2 { text-align: center; color: #212529; margin-bottom: 8px; }
    .subtitle { text-align: center; color: #6c757d; margin-bottom: 24px; font-size: 0.9em; }
    .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
    .input-group { padding: 16px; border: 1px solid #dee2e6; border-radius: 8px; }
    .input-group legend { font-weight: bold; color: #495057; padding: 0 8px; }
    .input-group label { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
    .input-group input[type="range"] { flex-grow: 1; margin: 0 10px; }
    .chart-container { position: relative; height: 350px; }
    .result { margin-top: 24px; font-size: 1.1em; line-height: 1.6; }
    .highlight { color: #007bff; font-weight: bold; }
    
    /* 数学公式样式 */
    .math-formula { 
      font-family: 'Times New Roman', serif; 
      font-size: 1.2em; 
      font-style: italic; 
      line-height: 1.8;
    }
    .math-large { font-size: 1.4em; }
    .math-fraction { display: inline-block; text-align: center; vertical-align: middle; }
    .math-fraction .numerator { border-bottom: 1px solid #333; padding-bottom: 2px; }
    .math-fraction .denominator { padding-top: 2px; }
    .math-subscript { font-size: 0.8em; vertical-align: sub; }
    .math-superscript { font-size: 0.8em; vertical-align: super; }
    .math-integral { font-size: 1.5em; }
    .math-expectation { font-size: 1.1em; font-weight: bold; }
    .math-log { font-size: 1.1em; font-style: normal; font-weight: normal; }
    .math-geq { margin: 0 5px; font-size: 1.2em; }
    .math-arrow { margin: 0 8px; font-size: 1.2em; }
    .math-color-green { color: #2e7d32; }
    .math-color-red { color: #d32f2f; }
    .math-color-blue { color: #1976d2; }
  </style>
</head>
<body>
  <div class="container">
    <h2>变分下界（ELBO）与KL散度可视化</h2>
    <p class="subtitle">观察ELBO组成部分：重构项与KL正则项的关系</p>
    <div class="input-grid">
      <fieldset class="input-group">
        <legend>真实分布 p(x)</legend>
        <label>均值 μ<sub>p</sub>: <input type="range" id="mu_p" min="-2.5" max="2.5" step="0.1" value="0"><span id="mu_p_val">0.0</span></label>
        <label>标准差 σ<sub>p</sub>: <input type="range" id="sigma_p" min="0.2" max="2" step="0.1" value="1"><span id="sigma_p_val">1.0</span></label>
      </fieldset>
      <fieldset class="input-group">
        <legend>近似分布 q(x)</legend>
        <label>均值 μ<sub>q</sub>: <input type="range" id="mu_q" min="-2.5" max="2.5" step="0.1" value="0.5"><span id="mu_q_val">0.5</span></label>
        <label>标准差 σ<sub>q</sub>: <input type="range" id="sigma_q" min="0.2" max="2" step="0.1" value="1.2"><span id="sigma_q_val">1.2</span></label>
      </fieldset>
    </div>
    <div class="chart-container-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 370px;">
      <div class="chart-container" style="position: relative; height: 100%; width: 100%;">
        <canvas id="pdfChart"></canvas>
      </div>
      <div class="chart-container" style="position: relative; height: 100%; width: 100%;">
        <canvas id="entropyChart"></canvas>
      </div>
    </div>
    <div class="result" id="result"></div>
    
    <!-- ELBO 数学推导 -->
    <div class="derivation-container" style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, #fff3e0 0%, #fce4ec 100%); border-radius: 12px; border: 1px solid #ffcc02;">
      <h3 style="text-align: center; color: #f57c00; margin-bottom: 16px;">📝 ELBO推导过程</h3>
      <div class="derivation-steps" style="background: white; padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; line-height: 2.2;">
        
        <div class="step" style="margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
          <div style="font-weight: bold; color: #007bff; margin-bottom: 8px;">Step 1: 从数据似然开始</div>
          <div class="formula math-formula" style="color: #333; background: white; padding: 16px; border-radius: 6px; margin: 8px 0; text-align: center;">
            <span class="math-log">log</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>) = <span class="math-log">log</span> <span class="math-integral">∫</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>,<span class="math-italic">z</span>) <span class="math-italic">dz</span>
          </div>
          <div style="color: #666; font-size: 0.9em; font-style: italic; margin-top: 8px;">
            💡 对潜在变量z进行边缘化，但这个积分通常无法解析计算
          </div>
        </div>

        <div class="step" style="margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
          <div style="font-weight: bold; color: #28a745; margin-bottom: 8px;">Step 2: 引入任意分布q(z|x)</div>
          <div class="formula math-formula" style="color: #333; background: white; padding: 16px; border-radius: 6px; margin: 8px 0; text-align: center;">
            <span class="math-log">log</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>) = <span class="math-log">log</span> <span class="math-integral">∫</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>,<span class="math-italic">z</span>) · 
            <span class="math-fraction math-color-green">
              <div class="numerator"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</div>
              <div class="denominator"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</div>
            </span> <span class="math-italic">dz</span>
          </div>
          <div style="color: #666; font-size: 0.9em; font-style: italic; margin-top: 8px;">
            🎯 巧妙的数学技巧：乘以1（q(z|x)/q(z|x)），为下一步做准备
          </div>
        </div>

        <!-- 期望概念解释 -->
        <div class="concept-explanation" style="margin-bottom: 20px; padding: 16px; background: #fff8e1; border-radius: 8px; border: 2px solid #ff9800;">
          <h4 style="color: #ff9800; margin: 0 0 12px 0; text-align: center;">📚 概念解释：期望操作</h4>
          
          <!-- 期望的本质 -->
          <div style="background: #fff3e0; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
            <h5 style="color: #e65100; margin: 0 0 8px 0;">🎯 期望的本质</h5>
            <div class="math-formula" style="text-align: center; background: white; padding: 12px; border-radius: 4px; font-size: 1.1em;">
              <span class="math-expectation">E</span><span class="math-subscript"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span>[<span class="math-italic">f</span>(<span class="math-italic">z</span>)] = <span class="math-integral">∫</span> <span class="math-italic">f</span>(<span class="math-italic">z</span>) · <span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>) <span class="math-italic">dz</span>
            </div>
            <div style="font-size: 0.9em; color: #666; margin-top: 8px; text-align: center;">
              <strong>翻译：</strong>权重函数q(z|x)与加权函数f(z)的乘积的积分
            </div>
          </div>


        </div>

        <div class="step" style="margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #dc3545;">
          <div style="font-weight: bold; color: #dc3545; margin-bottom: 8px;">Step 3: 转换为期望形式并应用Jensen不等式</div>
          <div class="formula math-formula" style="color: #333; background: white; padding: 16px; border-radius: 6px; margin: 8px 0; text-align: center;">
            <span class="math-log">log</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>) = <span class="math-log">log</span> <span class="math-expectation">E</span><span class="math-subscript"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span>
            [<span class="math-fraction">
              <div class="numerator"><span class="math-italic">p</span>(<span class="math-italic">x</span>,<span class="math-italic">z</span>)</div>
              <div class="denominator"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</div>
            </span>]
          </div>
          <div style="margin: 12px 0; text-align: center;">⬇️ <span style="color: #dc3545; font-weight: bold;">Jensen不等式（log是凹函数）</span></div>
          <div class="formula math-formula" style="color: #dc3545; background: #fff5f5; padding: 16px; border-radius: 6px; margin: 8px 0; border: 2px solid #dc3545; text-align: center;">
            <span class="math-geq">≥</span> <span class="math-expectation">E</span><span class="math-subscript"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span>[<span class="math-log">log</span> <span class="math-fraction">
              <div class="numerator"><span class="math-italic">p</span>(<span class="math-italic">x</span>,<span class="math-italic">z</span>)</div>
              <div class="denominator"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</div>
            </span>]
          </div>
          <div style="color: #666; font-size: 0.9em; font-style: italic; margin-top: 8px;">
            🔑 关键步骤：从"积分的对数"变为"对数的积分"，使计算变为可能
          </div>
        </div>

        <div class="step" style="margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #6f42c1;">
          <div style="font-weight: bold; color: #6f42c1; margin-bottom: 8px;">Step 4: 分解联合概率</div>
          <div class="formula math-formula" style="color: #333; background: white; padding: 16px; border-radius: 6px; margin: 8px 0; text-align: center;">
            = <span class="math-expectation">E</span><span class="math-subscript"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span>[<span class="math-log">log</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>|<span class="math-italic">z</span>) + <span class="math-log">log</span> <span class="math-italic">p</span>(<span class="math-italic">z</span>) - <span class="math-log">log</span> <span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)]
          </div>
          <div style="color: #666; font-size: 0.9em; font-style: italic; margin-top: 8px;">
            📐 利用联合概率分解：<span class="math-formula"><span class="math-italic">p</span>(<span class="math-italic">x</span>,<span class="math-italic">z</span>) = <span class="math-italic">p</span>(<span class="math-italic">x</span>|<span class="math-italic">z</span>)<span class="math-italic">p</span>(<span class="math-italic">z</span>)</span>，以及对数的加法性质
          </div>
        </div>

        <!-- Step 4.5: 关键转换 -->
        <div class="step" style="margin-bottom: 20px; padding: 16px; background: #fff8e1; border-radius: 8px; border-left: 4px solid #ff9800; border: 2px solid #ff9800;">
          <div style="font-weight: bold; color: #ff9800; margin-bottom: 12px;">Step 4.5: 关键转换</div>
          
          <div class="formula math-formula" style="color: #333; text-align: center; background: white; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
            <span class="math-expectation">E</span><span class="math-subscript"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span>[<span class="math-log">log</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>|<span class="math-italic">z</span>) + <span class="math-log">log</span> <span class="math-italic">p</span>(<span class="math-italic">z</span>) - <span class="math-log">log</span> <span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)]
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div style="background: #e8f5e9; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 0.8em; color: #2e7d32;"><strong>①期望线性性</strong></div>
              <div style="font-size: 0.75em;">E[A+B+C] = E[A]+E[B]+E[C]</div>
            </div>
            <div style="background: #e3f2fd; padding: 8px; border-radius: 4px; text-align: center;">
              <div style="font-size: 0.8em; color: #1976d2;"><strong>②对数性质</strong></div>
              <div style="font-size: 0.75em;">log a - log b = log(a/b)</div>
            </div>
          </div>

          <div class="formula math-formula" style="color: #333; text-align: center; background: white; padding: 12px; border-radius: 6px; margin-bottom: 8px;">
            = <span class="math-color-green"><span class="math-expectation">E</span><span class="math-subscript"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span>[<span class="math-log">log</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>|<span class="math-italic">z</span>)]</span> + <span class="math-expectation">E</span><span class="math-subscript"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span>[<span class="math-log">log</span> <span class="math-fraction">
              <div class="numerator"><span class="math-italic">p</span>(<span class="math-italic">z</span>)</div>
              <div class="denominator"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</div>
            </span>]
          </div>

          <!-- KL散度识别 -->
          <div style="background: #fff3e0; padding: 8px; border-radius: 4px; border-left: 3px solid #ff9800;">
            <div style="font-size: 0.85em; color: #e65100; text-align: center;">
              <strong>💡 关键洞察：</strong>后一项正好是<strong style="color: #d32f2f;">KL散度的负值</strong>！<br>
              <span style="font-size: 0.8em; color: #666;">KL散度 = 权重函数q也出现在被积函数中的特殊期望</span>
            </div>
          </div>

          <div class="formula math-formula" style="color: #d32f2f; text-align: center; background: #ffebee; padding: 8px; border-radius: 4px; margin-top: 8px;">
            = <span class="math-color-green"><span class="math-expectation">E</span><span class="math-subscript"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span>[<span class="math-log">log</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>|<span class="math-italic">z</span>)]</span> - <span class="math-color-red"><span class="math-italic">D</span><span class="math-subscript">KL</span>(<span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>) ∥ <span class="math-italic">p</span>(<span class="math-italic">z</span>))</span>
          </div>
        </div>

        <!-- KL散度定义详解 - 移到step4.5 -->
        <div class="concept-section" style="padding: 16px; background: #fff8e1; border-radius: 8px; border-left: 4px solid #ff9800; margin-top: 12px;">
          <h5 style="color: #f57c00; margin: 0 0 8px 0;">📚 KL散度的完整定义</h5>
          
          <div style="background: #ffebee; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
            <div class="math-formula" style="text-align: center; background: white; padding: 16px; border-radius: 4px; font-size: 1.2em; border: 2px solid #d32f2f;">
              <span class="math-italic">D</span><span class="math-subscript">KL</span>(<span class="math-italic">q</span>∥<span class="math-italic">p</span>) = <span class="math-expectation">E</span><span class="math-subscript" style="color: #d32f2f;"><span class="math-italic">q</span></span>[<span class="math-log">log</span> <span class="math-fraction">
                <div class="numerator" style="color: #d32f2f;"><span class="math-italic">q</span></div>
                <div class="denominator"><span class="math-italic">p</span></div>
              </span>]
            </div>
            <div style="margin-top: 12px; font-size: 0.9em; text-align: center;">
              <div style="background: #f5f5f5; padding: 8px; border-radius: 4px;">
                <strong>展开形式：</strong> <span class="math-formula"><span class="math-integral">∫</span> <span class="math-italic" style="color: #d32f2f;">q</span>(<span class="math-italic">z</span>) <span class="math-log">log</span> <span class="math-fraction"><div class="numerator" style="color: #d32f2f;"><span class="math-italic">q</span>(<span class="math-italic">z</span>)</div><div class="denominator"><span class="math-italic">p</span>(<span class="math-italic">z</span>)</div></span> <span class="math-italic">dz</span></span>
              </div>
            </div>
          </div>

          <div style="background: #fff3e0; padding: 12px; border-radius: 6px; border: 2px solid #ff9800;">
            <div style="font-weight: bold; color: #f57c00; margin-bottom: 8px; text-align: center;">🌟 KL散度的独特之处</div>
            <div style="font-size: 0.9em; text-align: center; color: #c62828;">
              同一个分布<strong>q</strong>既作为<strong>积分权重</strong>，又出现在<strong>被积函数</strong>中！
            </div>
          </div>
        </div>

        <div class="step" style="margin-bottom: 20px; padding: 16px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #2e7d32; border: 2px solid #2e7d32;">
          <div style="font-weight: bold; color: #2e7d32; margin-bottom: 8px;">Step 5: 重新组合得到ELBO</div>
          <div class="formula math-formula math-large" style="color: #2e7d32; background: white; padding: 20px; border-radius: 6px; margin: 8px 0; font-weight: bold; border: 2px solid #2e7d32; text-align: center;">
            <strong>ELBO</strong> = <span class="math-color-green"><span class="math-expectation">E</span><span class="math-subscript"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span>[<span class="math-log">log</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>|<span class="math-italic">z</span>)]</span> - <span class="math-color-red"><span class="math-italic">D</span><span class="math-subscript">KL</span>(<span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>) ∥ <span class="math-italic">p</span>(<span class="math-italic">z</span>))</span>
          </div>
          
          <!-- 公式元素详细解释 -->
          <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; border: 1px solid #dee2e6; margin: 12px 0;">
            <h5 style="color: #495057; margin: 0 0 8px 0; font-size: 0.9em;">📝 公式元素详解：</h5>
            <div style="font-size: 0.8em; line-height: 1.6; color: #333;">
              <div style="margin-bottom: 6px;"><strong style="color: #2e7d32;">重构项</strong> <span class="math-formula"><span class="math-expectation">E</span><span class="math-subscript"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span>[<span class="math-log">log</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>|<span class="math-italic">z</span>)]</span>：</div>
              <div style="margin-left: 12px; margin-bottom: 8px;">
                • <span class="math-formula"><span class="math-expectation">E</span><span class="math-subscript"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span></span>：在分布<span class="math-formula"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span>下求期望，即从该分布采样z来计算<br>
                • <span class="math-formula"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span>：编码器/推理网络，将数据x编码为潜在变量z的分布<br>
                • <span class="math-formula"><span class="math-log">log</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>|<span class="math-italic">z</span>)</span>：<span style="color: #d32f2f; font-weight: bold;">注意！这里的p(x|z)有双重身份</span><br>
                &nbsp;&nbsp;&nbsp;&nbsp;① <strong>数学上</strong>：真实的条件概率分布（给定z时x的真实概率）<br>
                &nbsp;&nbsp;&nbsp;&nbsp;② <strong>实现上</strong>：用解码器神经网络来参数化/建模这个真实分布<br>
                • <strong style="color: #9c27b0;">积分变量</strong>：完整形式是<span class="math-formula"><span class="math-integral">∫</span> <span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>) <span class="math-log">log</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>|<span class="math-italic">z</span>) <span class="math-italic" style="color: #9c27b0;">dz</span></span>，积分对象是潜在变量z<br>
                • <strong style="color: #9c27b0;">关键澄清</strong>：虽然q(z|x)中x看似"自变量"，但在条件概率中x是<strong>条件参数</strong>，z才是<strong>随机变量</strong>！给定固定的x，我们对所有可能z值积分<br>
                • <strong style="color: #2e7d32;">可计算性</strong>：完全可计算！通过蒙特卡洛采样近似<br>
                • <strong style="color: #2e7d32;">参数更新</strong>：会随编码器/解码器参数更新而改变<br>
                • <strong style="color: #1976d2;">蒙特卡洛采样</strong>：从q(z|x)随机采样几个z值，计算log p(x|z)的平均值来近似期望<br>
                • <strong style="color: #ff9800;">🔧 log p(x|z)计算</strong>：解码器输出重构分布参数，然后计算给定z下观测x的对数概率<br>
                • <strong style="color: #ff9800;">具体实现例子</strong>：①<strong>连续数据</strong>-解码器输出μ(z),σ(z)，则log p(x|z)=log N(x;μ(z),σ(z)) ②<strong>离散数据</strong>-输出logits，用交叉熵损失
              </div>
              
              <div style="margin-bottom: 6px;"><strong style="color: #d32f2f;">KL正则项</strong> <span class="math-formula"><span class="math-italic">D</span><span class="math-subscript">KL</span>(<span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>) ∥ <span class="math-italic">p</span>(<span class="math-italic">z</span>))</span>：</div>
              <div style="margin-left: 12px;">
                • <span class="math-formula"><span class="math-italic">D</span><span class="math-subscript">KL</span></span>：KL散度，衡量两个分布的差异<br>
                • <span class="math-formula"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span>：编码器输出的后验分布（实际学到的分布）<br>
                • <span class="math-formula"><span class="math-italic">p</span>(<span class="math-italic">z</span>)</span>：先验分布（通常是标准正态分布N(0,I)）<br>
                • ∥：KL散度符号，表示"相对于"的意思<br>
                • <strong style="color: #d32f2f;">可计算性</strong>：高斯分布时有解析解，其他情况用采样<br>
                • <strong style="color: #d32f2f;">参数更新</strong>：仅随编码器参数更新而改变（p(z)固定）<br>
                • <strong style="color: #673ab7;">p(z)深度理解</strong>：先验分布是我们对潜在变量z的<strong>先验假设</strong>，通常选择N(0,I)是为了让潜在空间规整化<br>
                • <strong style="color: #673ab7;">p(z)的作用</strong>：防止编码器"作弊"（把每个x映射到独特的z），强制学习连续、可插值的潜在表示空间<br>
                • <strong style="color: #e91e63;">为什么是标准正态</strong>：①<strong>数学便利</strong>-KL散度有解析解 ②<strong>中心对称</strong>-均值0无偏向 ③<strong>连续平滑</strong>-支持插值<br>
                • <strong style="color: #e91e63;">更深层原因</strong>：④<strong>重参数化</strong>-支持z=μ+σε技巧 ⑤<strong>最大熵</strong>-给定方差约束下信息量最大 ⑥<strong>无界覆盖</strong>-可表达任意复杂分布<br>
                • <strong style="color: #d32f2f;">⚠️ 潜在偏差</strong>：真实的p(z)可能不是N(0,I)！这是<strong>人为假设</strong>，当真实先验与标准正态差异很大时会引入偏差<br>
                • <strong style="color: #d32f2f;">权衡考虑</strong>：虽有偏差但实际可行-①<strong>网络补偿</strong>能力强 ②<strong>数学优势</strong>明显 ③<strong>经验效果</strong>良好 ④可用<strong>其他先验</strong>(如混合高斯)改进<br>
                • <strong style="color: #ff5722;">🤔 KL计算疑问</strong>：p(z)=N(0,I)是<strong>人为设定</strong>的，完全已知！不需要"计算"，而是我们规定的固定分布<br>
                • <strong style="color: #ff5722;">💡 解析解存在</strong>：D_KL(N(μ,σ²)||N(0,I)) = ½∑[σ²+μ²-1-log(σ²)]，两个高斯分布间KL散度有闭式解
              </div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
            <div style="text-align: center; padding: 8px; background: rgba(46, 125, 50, 0.1); border-radius: 6px;">
              <div style="color: #2e7d32; font-weight: bold;">📈 重构项</div>
              <div class="math-formula" style="font-size: 0.8em; color: #2e7d32;"><span class="math-expectation">E</span><span class="math-subscript"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span>[<span class="math-log">log</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>|<span class="math-italic">z</span>)]</div>
            </div>
            <div style="text-align: center; padding: 8px; background: rgba(211, 47, 47, 0.1); border-radius: 6px;">
              <div style="color: #d32f2f; font-weight: bold;">🔧 KL正则项</div>
              <div class="math-formula" style="font-size: 0.8em; color: #d32f2f;"><span class="math-italic">D</span><span class="math-subscript">KL</span>(<span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>) ∥ <span class="math-italic">p</span>(<span class="math-italic">z</span>))</div>
            </div>
          </div>
        </div>
      </div>
      

    </div>

    
    
    <!-- p(x|z)身份澄清 -->
    <div class="identity-clarification" style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, #ffebee 0%, #fff3e0 100%); border-radius: 12px; border: 2px solid #d32f2f;">
      <h3 style="text-align: center; color: #d32f2f; margin-bottom: 16px;">🔍 重要澄清：p(x|z)的双重身份</h3>
      
      <!-- 困惑点说明 -->
      <div style="background: #fff; padding: 16px; border-radius: 8px; border-left: 4px solid #f57c00; margin-bottom: 16px;">
        <h4 style="color: #f57c00; margin: 0 0 8px 0;">🤔 常见困惑</h4>
        <div style="font-size: 0.9em; line-height: 1.6; color: #333;">
          <strong>问题：</strong>"ELBO推导中，p一直代表真实分布，为什么log p(x|z)突然变成解码器网络了？"<br>
          <strong>答案：</strong>这不是"突然变成"，而是p(x|z)本身就有<span style="color: #d32f2f; font-weight: bold;">双重身份</span>！
        </div>
      </div>

      <!-- 双重身份详解 -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
        <!-- 数学身份 -->
        <div style="background: #e8f5e9; padding: 16px; border-radius: 8px; border: 2px solid #4caf50;">
          <h4 style="color: #2e7d32; margin: 0 0 12px 0; text-align: center;">👑 数学身份</h4>
          <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
            <div class="math-formula" style="text-align: center; font-size: 1.1em; margin-bottom: 8px;">
              <span class="math-italic">p</span>(<span class="math-italic">x</span>|<span class="math-italic">z</span>) = 真实的条件概率分布
            </div>
            <div style="font-size: 0.85em; color: #666; text-align: center;">
              给定潜在变量z，数据x的真实概率密度
            </div>
          </div>
          <ul style="font-size: 0.85em; margin: 0; line-height: 1.6; color: #333;">
            <li><strong>完全确定</strong>：对每个(x,z)对，都有唯一真实值</li>
            <li><strong>来自自然</strong>：客观存在，不依赖我们的模型</li>
            <li><strong>推导地位</strong>：在ELBO推导中始终是"真实分布"</li>
            <li><strong>联合分解</strong>：p(x,z) = p(x|z)p(z)</li>
          </ul>
        </div>

        <!-- 实现身份 -->
        <div style="background: #e3f2fd; padding: 16px; border-radius: 8px; border: 2px solid #2196f3;">
          <h4 style="color: #1976d2; margin: 0 0 12px 0; text-align: center;">⚙️ 实现身份</h4>
          <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
            <div class="math-formula" style="text-align: center; font-size: 1.1em; margin-bottom: 8px;">
              <span class="math-italic">p</span>(<span class="math-italic">x</span>|<span class="math-italic">z</span>) ≈ 解码器网络<span class="math-subscript">θ</span>(<span class="math-italic">z</span>)
            </div>
            <div style="font-size: 0.85em; color: #666; text-align: center;">
              用神经网络参数化这个真实分布
            </div>
          </div>
          <ul style="font-size: 0.85em; margin: 0; line-height: 1.6; color: #333;">
            <li><strong>可训练</strong>：网络参数θ通过数据学习</li>
            <li><strong>近似目标</strong>：努力逼近真实的p(x|z)</li>
            <li><strong>计算载体</strong>：让抽象概率变为可计算</li>
            <li><strong>优化对象</strong>：在ELBO中被优化</li>
          </ul>
        </div>
      </div>

      <!-- 关键洞察 -->
      <div style="background: #fff8e1; padding: 16px; border-radius: 8px; border: 2px solid #ff9800;">
        <h4 style="color: #f57c00; margin: 0 0 12px 0; text-align: center;">💡 关键洞察：为什么会有双重身份？</h4>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
          <div style="background: white; padding: 10px; border-radius: 6px; text-align: center;">
            <div style="font-weight: bold; color: #e65100; margin-bottom: 4px;">🎯 目标</div>
            <div style="font-size: 0.8em;">要最大化真实的log p(x|z)</div>
          </div>
          <div style="background: white; padding: 10px; border-radius: 6px; text-align: center;">
            <div style="font-weight: bold; color: #e65100; margin-bottom: 4px;">❌ 问题</div>
            <div style="font-size: 0.8em;">真实p(x|z)未知，无法直接计算</div>
          </div>
          <div style="background: white; padding: 10px; border-radius: 6px; text-align: center;">
            <div style="font-weight: bold; color: #e65100; margin-bottom: 4px;">✅ 解决</div>
            <div style="font-size: 0.8em;">用解码器网络来建模/近似它</div>
          </div>
        </div>

        <div style="background: white; padding: 12px; border-radius: 6px;">
          <div style="font-size: 0.9em; text-align: center; line-height: 1.6; color: #333;">
            <strong style="color: #d32f2f;">核心理解：</strong><br>
            数学推导中的p(x|z)是<span style="color: #2e7d32; font-weight: bold;">理想目标</span>，<br>
            解码器网络是<span style="color: #1976d2; font-weight: bold;">实现手段</span>。<br>
            <span style="color: #f57c00; font-weight: bold;">两者指向同一个概率分布，只是不同层面的描述！</span>
          </div>
        </div>
      </div>


    </div>

    <!-- 核心问题解答 -->
    <div class="qa-container" style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, #f3e5f5 0%, #e8f5e8 100%); border-radius: 12px; border: 1px solid #ce93d8;">
      <h3 style="text-align: center; color: #8e24aa; margin-bottom: 16px;">❓ 核心问题解答</h3>
      
      <div class="qa-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div class="qa-item" style="padding: 16px; background: white; border-radius: 8px; border-left: 4px solid #8e24aa;">
          <h4 style="color: #8e24aa; margin: 0 0 12px 0;">💡 ELBO是信息量吗？</h4>
          <p style="margin: 0; font-size: 0.9em; line-height: 1.6;">
            <strong>是的！</strong> ELBO可以理解为一种"可达到的信息量"：<br>
            • <span class="math-formula"><span class="math-log">log</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>)</span> = 真实信息量（观测数据的惊喜度）<br>
            • ELBO = 我们模型能捕获的信息量下界<br>
            • 差值 = 信息损失（因为用<span class="math-formula"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span>近似<span class="math-formula"><span class="math-italic">p</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span>）
          </p>
        </div>
        
        <div class="qa-item" style="padding: 16px; background: white; border-radius: 8px; border-left: 4px solid #388e3c;">
          <h4 style="color: #388e3c; margin: 0 0 12px 0;">🎯 为什么最大化ELBO？</h4>
          <p style="margin: 0; font-size: 0.9em; line-height: 1.6;">
            因为我们<strong>无法直接计算</strong><span class="math-formula"><span class="math-log">log</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>)</span>：<br>
            • <span class="math-formula"><span class="math-italic">p</span>(<span class="math-italic">x</span>) = <span class="math-integral">∫</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>|<span class="math-italic">z</span>)<span class="math-italic">p</span>(<span class="math-italic">z</span>)<span class="math-italic">dz</span></span> 积分难解<br>
            • ELBO是可计算的下界<br>
            • 最大化ELBO = 间接提升<span class="math-formula"><span class="math-log">log</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>)</span><br>
            • 当<span class="math-formula"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)=<span class="math-italic">p</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span>时，ELBO=<span class="math-formula"><span class="math-log">log</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>)</span>
          </p>
        </div>
        

        
        <div class="qa-item" style="padding: 16px; background: white; border-radius: 8px; border-left: 4px solid #f57c00;">
          <h4 style="color: #f57c00; margin: 0 0 12px 0;">⚖️ Jensen不等式为啥成立？</h4>
          <p style="margin: 0; font-size: 0.9em; line-height: 1.6;">
            因为<span class="math-formula"><span class="math-log">log</span></span>是<strong>凹函数</strong>：<br>
            • <span class="math-formula"><span class="math-log">log</span>(<span class="math-expectation">E</span>[<span class="math-italic">X</span>]) <span class="math-geq">≥</span> <span class="math-expectation">E</span>[<span class="math-log">log</span>(<span class="math-italic">X</span>)]</span><br>
            • 积分的对数 ≥ 对数的积分<br>
            • 等号成立条件：<span class="math-formula"><span class="math-italic">X</span></span>为常数<br>
            • 即：<span class="math-formula"><span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>) = <span class="math-italic">p</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span>时取等号
          </p>
        </div>
        
        <div class="qa-item" style="padding: 16px; background: white; border-radius: 8px; border-left: 4px solid #9c27b0;">
          <h4 style="color: #9c27b0; margin: 0 0 12px 0;">🤔 为啥不直接最小化KL散度？</h4>
          <p style="margin: 0; font-size: 0.9em; line-height: 1.6;">
            因为<strong>真实后验</strong><span class="math-formula"><span class="math-italic">p</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)</span><strong>无法计算</strong>：<br>
            • <span class="math-formula"><span class="math-italic">p</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>) = <span class="math-italic">p</span>(<span class="math-italic">x</span>|<span class="math-italic">z</span>)<span class="math-italic">p</span>(<span class="math-italic">z</span>)/<span class="math-italic">p</span>(<span class="math-italic">x</span>)</span><br>
            • 分母<span class="math-formula"><span class="math-italic">p</span>(<span class="math-italic">x</span>) = <span class="math-integral">∫</span><span class="math-italic">p</span>(<span class="math-italic">x</span>|<span class="math-italic">z</span>)<span class="math-italic">p</span>(<span class="math-italic">z</span>)<span class="math-italic">dz</span></span> 积分难解<br>
            • 无法计算<span class="math-formula"><span class="math-italic">D</span><span class="math-subscript">KL</span>(<span class="math-italic">q</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>)||<span class="math-italic">p</span>(<span class="math-italic">z</span>|<span class="math-italic">x</span>))</span><br>
            • ELBO巧妙绕过，变成可计算的形式
          </p>
        </div>
        

      </div>
    </div>
    
    <!-- 为什么必须用ELBO的解释 -->
    <div class="why-elbo-container" style="margin-top: 24px; padding: 16px; background: linear-gradient(135deg, #fce4ec 0%, #e1f5fe 100%); border-radius: 12px; border: 1px solid #e91e63;">
      <h3 style="text-align: center; color: #e91e63; margin-bottom: 12px;">🎯 深入理解潜在变量z</h3>
      
      <!-- z的来源解释 -->
      <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 4px solid #9c27b0;">
        <h4 style="color: #9c27b0; margin: 0 0 8px 0;">🤔 z从哪里来？为什么要积分？</h4>
                 <p style="margin: 0; font-size: 0.9em; line-height: 1.5; color: #333;">
           <strong><span class="math-formula"><span class="math-italic">z</span></span>是潜在变量</strong>，在不同模型中有不同含义：<br>
           • <strong>主题模型LDA</strong>：文档<span class="math-formula"><span class="math-italic">x</span></span>由主题分布<span class="math-formula"><span class="math-italic">z</span></span>生成<br>
           • <strong>高斯混合模型</strong>：数据点<span class="math-formula"><span class="math-italic">x</span></span>来自哪个高斯分量<span class="math-formula"><span class="math-italic">z</span></span><br>
           • <strong>VAE模型</strong>：图像<span class="math-formula"><span class="math-italic">x</span></span>的编码表示<span class="math-formula"><span class="math-italic">z</span></span><br>
           • <strong>扩散模型</strong>：噪声序列<span class="math-formula"><span class="math-italic">z</span> = {<span class="math-italic">x</span><span class="math-subscript">1</span>, <span class="math-italic">x</span><span class="math-subscript">2</span>, ..., <span class="math-italic">x</span><span class="math-subscript">T</span>}</span>的逐步去噪过程<br>
           要计算<span class="math-formula"><span class="math-italic">p</span>(<span class="math-italic">x</span>)</span>，必须考虑所有可能的<span class="math-formula"><span class="math-italic">z</span></span>：<span class="math-formula math-color-blue"><span class="math-italic">p</span>(<span class="math-italic">x</span>) = <span class="math-integral">∫</span> <span class="math-italic">p</span>(<span class="math-italic">x</span>|<span class="math-italic">z</span>)<span class="math-italic">p</span>(<span class="math-italic">z</span>)<span class="math-italic">dz</span></span>
         </p>
      </div>

      <!-- 深入理解z -->
      <div style="background: linear-gradient(135deg, #e3f2fd, #f3e5f5); padding: 20px; border-radius: 12px; border: 2px solid #2196f3; margin-bottom: 12px;">

        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <!-- 哲学视角 -->
          <div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid #9c27b0;">
            <h5 style="color: #9c27b0; margin: 0 0 8px 0;">🤔 哲学视角：隐藏的因果</h5>
            <p style="font-size: 0.85em; margin: 0; line-height: 1.6; color: #333;">
              <strong>z是数据背后的"故事"</strong>：<br>
              • 你看到一张笑脸照片(x)，但背后的情绪状态(z)是隐藏的<br>
              • 你读到一篇文章(x)，但作者的主题意图(z)是潜在的<br>
              • z解释了"为什么x会是这样"
            </p>
          </div>
          
          <!-- 数学视角 -->
          <div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid #ff5722;">
            <h5 style="color: #ff5722; margin: 0 0 8px 0;">📊 数学视角：降维的本质</h5>
            <p style="font-size: 0.85em; margin: 0; line-height: 1.6; color: #333;">
              <strong>z是信息的压缩编码</strong>：<br>
              • 高维数据x(如1024×1024图片)的低维表示z(如64维向量)<br>
              • z捕获了x的"精华信息"，去除了冗余<br>
              • 类似于MP3压缩音频的核心思想
            </p>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <!-- 生成视角 -->
          <div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid #4caf50;">
            <h5 style="color: #4caf50; margin: 0 0 8px 0;">🎨 生成视角：创造的蓝图</h5>
            <p style="font-size: 0.85em; margin: 0; line-height: 1.6; color: #333;">
              <strong>z是生成x的"配方"</strong>：<br>
              • 给定z，就能重构/生成对应的x<br>
              • 改变z的值，就能创造不同的x<br>
              • z空间的连续性保证了生成的多样性
            </p>
          </div>
          
          <!-- 学习视角 -->
          <div style="background: white; padding: 12px; border-radius: 8px; border-left: 3px solid #ff9800;">
            <h5 style="color: #ff9800; margin: 0 0 8px 0;">🎯 学习视角：表示的发现</h5>
            <p style="font-size: 0.85em; margin: 0; line-height: 1.6; color: #333;">
              <strong>z是模型学到的"理解"</strong>：<br>
              • 模型通过大量数据x学习到有用的表示z<br>
              • 好的z能够区分不同类别、捕获重要特征<br>
              • z的质量决定了模型的表现力
            </p>
          </div>
        </div>

        <!-- 核心洞察 -->
        <div style="background: linear-gradient(135deg, #fff9c4, #f8bbd9); padding: 16px; border-radius: 8px; border: 2px solid #ffc107;">
          <h5 style="color: #e65100; margin: 0 0 12px 0; text-align: center;">💡 核心洞察：z的三重身份</h5>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; font-size: 0.85em;">
            <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.7); border-radius: 6px;">
              <div style="font-weight: bold; color: #1976d2;">🔍 观察者</div>
              <div>解释已有数据x</div>
            </div>
            <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.7); border-radius: 6px;">
              <div style="font-weight: bold; color: #388e3c;">🎨 创造者</div>
              <div>生成新的数据x</div>
            </div>
            <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.7); border-radius: 6px;">
              <div style="font-weight: bold; color: #f57c00;">🧭 导航者</div>
              <div>连接不同的x</div>
            </div>
          </div>
        </div>
      </div>
      

      

    </div>
    
    <!-- 凹凸函数判断标准 -->
    <div class="concave-convex-container" style="margin-top: 24px; padding: 16px; background: linear-gradient(135deg, #e8f5e9 0%, #f3e5f5 100%); border-radius: 12px; border: 1px solid #4caf50;">
      <h3 style="text-align: center; color: #2e7d32; margin-bottom: 12px;">📐 凹凸函数判断标准</h3>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
        <!-- 判断标准 -->
        <div style="background: white; padding: 12px; border-radius: 6px;">
          <div class="math-formula" style="text-align: center; line-height: 2.0;">
            <div><strong style="color: #2e7d32;">凹函数:</strong> <span class="math-italic">f</span><span class="math-superscript">''</span>(<span class="math-italic">x</span>) < 0, 连线在曲线上方</div>
            <div><strong style="color: #d32f2f;">凸函数:</strong> <span class="math-italic">f</span><span class="math-superscript">''</span>(<span class="math-italic">x</span>) > 0, 连线在曲线下方</div>
          </div>
        </div>
        
        <!-- 常见例子 -->
        <div style="background: white; padding: 12px; border-radius: 6px;">
          <div class="math-formula" style="font-size: 0.9em; line-height: 1.8;">
            • <span class="math-log">log</span>(<span class="math-italic">x</span>) → <span style="color: #2e7d32;">凹函数</span><br>
            • <span class="math-italic">x</span><span class="math-superscript">2</span> → <span style="color: #d32f2f;">凸函数</span>
          </div>
        </div>
      </div>

      <!-- Jensen不等式核心应用 -->
      <div style="background: white; padding: 12px; border-radius: 6px; border: 2px solid #9c27b0;">
        <div style="text-align: center; margin-bottom: 8px;">
          <strong style="color: #9c27b0;">🔑 Jensen不等式 → ELBO推导</strong>
        </div>
        <div class="math-formula" style="text-align: center; background: #f3e5f5; padding: 12px; border-radius: 4px;">
          <span class="math-log">log</span>是凹函数 <span class="math-arrow">⇒</span> <span class="math-log">log</span>(<span class="math-expectation">E</span>[<span class="math-italic">X</span>]) <span class="math-geq">≥</span> <span class="math-expectation">E</span>[<span class="math-log">log</span>(<span class="math-italic">X</span>)]
          <div style="color: #9c27b0; margin-top: 8px;">
            即：<span class="math-log">log</span>(<span class="math-integral">∫</span> <span class="math-italic">p</span> <span class="math-italic">dz</span>) <span class="math-geq">≥</span> <span class="math-integral">∫</span> <span class="math-log">log</span>(<span class="math-italic">p</span>) <span class="math-italic">dz</span>
          </div>
        </div>
      </div>
    </div>

    
    <div class="explanation-container" style="margin-top: 24px; display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px;">
      <div class="explanation-item" style="padding: 16px; background-color: #f1f3f5; border-radius: 8px;">
        <h4 style="display: flex; align-items: center; gap: 8px; margin: 0 0 12px 0;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
          ELBO信息量解释
        </h4>
        <ul style="font-size: 0.85em; padding-left: 20px; margin: 0; line-height: 1.7;">
          <li><b>信息量视角:</b> log p(x)是数据x的真实信息量，ELBO是我们能估计到的信息量下界。</li>
          <li><b>重构项来源:</b> E<sub>q(z|x)</sub>[log p(x|z)]是从潜在变量z重构原始数据x的期望对数似然。</li>
          <li><b>KL正则项:</b> 控制编码器不要"作弊"，强制学习规整的潜在空间。</li>
          <li><b>为啥最大化ELBO:</b> 无法直接计算log p(x)，通过最大化下界间接提升数据似然。</li>
          <li style="margin-top: 8px; color: #6c757d;"><b>核心:</b> ELBO = 生成质量 - 复杂度惩罚</li>
        </ul>
      </div>
      <div class="explanation-item" style="padding: 16px; background-color: #f1f3f5; border-radius: 8px;">
        <h4 style="display: flex; align-items: center; gap: 8px; margin: 0 0 12px 0;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/></svg>
          多模型应用
        </h4>
        <p style="font-size: 0.85em; margin: 0; line-height: 1.7;">
          <b>ELBO广泛应用</b>于各种潜在变量模型的训练和推理。
        </p>
        <ul style="font-size: 0.85em; padding-left: 20px; margin: 8px 0 0 0; line-height: 1.7;">
          <li><b>主题模型LDA:</b> 文档主题分布推理，z为主题权重。</li>
          <li><b>高斯混合模型:</b> 聚类分析，z为分量标签。</li>
          <li><b>变分自编码器:</b> 生成模型，z为编码表示。</li>
          <li><b>扩散模型DDPM:</b> 逐步去噪生成，z为噪声序列轨迹。</li>
          <li><b>贝叶斯神经网络:</b> 权重不确定性，z为网络参数。</li>
        </ul>
      </div>
      <div class="explanation-item" style="padding: 16px; background-color: #f1f3f5; border-radius: 8px;">
        <h4 style="display: flex; align-items: center; gap: 8px; margin: 0 0 12px 0;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
          ELBO优化指导
        </h4>
        <ul style="font-size: 0.85em; padding-left: 20px; margin: 0; line-height: 1.7;">
          <li><b>调参策略:</b> β值控制重构与正则化平衡，β=1为标准VAE。</li>
          <li><b>收敛监控:</b> ELBO上升表示训练进展，各项分别监控诊断问题。</li>
          <li><b>潜在维度:</b> 过高导致后验崩塌，过低限制表示能力。</li>
          <li><b>应用扩展:</b> β-VAE、WAE、InfoVAE等改进ELBO形式。</li>
        </ul>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let pdfChartInstance = null;
      let entropyChartInstance = null;
      const inputs = {
        mu_p: document.getElementById('mu_p'), sigma_p: document.getElementById('sigma_p'),
        mu_q: document.getElementById('mu_q'), sigma_q: document.getElementById('sigma_q'),
      };
      const values = {
        mu_p_val: document.getElementById('mu_p_val'), sigma_p_val: document.getElementById('sigma_p_val'),
        mu_q_val: document.getElementById('mu_q_val'), sigma_q_val: document.getElementById('sigma_q_val'),
      };
      const pdfCtx = document.getElementById('pdfChart').getContext('2d');
      const entropyCtx = document.getElementById('entropyChart').getContext('2d');

      const safeLog = (x) => (x > 0 ? Math.log(x) : -Infinity);
      const entropyDensity = (p, base_p) => (p > 0 ? -p * safeLog(base_p) : 0);

      function normalPDF(x, mu, sigma) {
        return (1 / (sigma * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - mu) / sigma, 2));
      }

      function calcMetrics(p, q) {
        const H = 0.5 * Math.log(2 * Math.PI * Math.E * p.sigma * p.sigma);
        const Hpq = 0.5 * Math.log(2 * Math.PI * q.sigma * q.sigma) + (p.sigma * p.sigma + Math.pow(p.mu - q.mu, 2)) / (2 * q.sigma * q.sigma);
        const KL = Hpq - H;
        return { H, Hpq, KL };
      }

      function drawCharts(p_params, q_params) {
        if (pdfChartInstance) {
          pdfChartInstance.destroy();
        }
        if (entropyChartInstance) {
          entropyChartInstance.destroy();
        }

        const dataPoints = [];
        for (let x = -5; x <= 5; x += 0.1) {
          const p_val = normalPDF(x, p_params.mu, p_params.sigma);
          const q_val = normalPDF(x, q_params.mu, q_params.sigma);
          const h_density = entropyDensity(p_val, p_val);
          const hpq_density = entropyDensity(p_val, q_val);
          dataPoints.push({
            x: x.toFixed(1),
            p_density: p_val,
            q_density: q_val,
            h_density: h_density,
            hpq_density: hpq_density,
            kl_density: hpq_density - h_density,
          });
        }

        pdfChartInstance = new Chart(pdfCtx, {
          type: 'line',
          data: {
            labels: dataPoints.map(d => d.x),
            datasets: [
              { label: 'p(x) 真实分布', data: dataPoints.map(d => d.p_density), borderColor: 'rgba(60, 60, 60, 1)', borderWidth: 2.5 },
              { label: 'q(x) 近似分布', data: dataPoints.map(d => d.q_density), borderColor: 'rgba(150, 150, 150, 1)', borderWidth: 2.5, borderDash: [5, 5] },
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            elements: { point: { radius: 0 }, line: { tension: 0.2 } },
            scales: {
              y: { type: 'linear', position: 'left', min: 0, max: 2.0, title: { display: true, text: '概率密度' } },
              x: { title: { display: true, text: 'x' } }
            },
            plugins: {
              title: { display: true, text: '概率密度函数比较' }
            },
            animation: { duration: 0 }
          }
        });

        entropyChartInstance = new Chart(entropyCtx, {
          type: 'line',
          data: {
            labels: dataPoints.map(d => d.x),
            datasets: [
              { label: '熵密度: p(x)·[-ln(p(x))]', data: dataPoints.map(d => d.h_density), borderColor: 'rgba(54, 162, 235, 0.7)', fill: true, backgroundColor: 'rgba(54, 162, 235, 0.2)' },
              { label: '交叉熵密度: p(x)·[-ln(q(x))]', data: dataPoints.map(d => d.hpq_density), borderColor: 'rgba(255, 99, 132, 0.7)', fill: true, backgroundColor: 'rgba(255, 99, 132, 0.2)' },
              { label: 'KL散度密度: p(x)·ln(p(x)/q(x))', data: dataPoints.map(d => d.kl_density), borderColor: 'rgba(255, 206, 86, 0.8)', fill: true, backgroundColor: 'rgba(255, 206, 86, 0.3)' },
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            elements: { point: { radius: 0 }, line: { tension: 0.2 } },
            scales: {
              y: { type: 'linear', position: 'left', min: -1.5, max: 2.5, title: { display: true, text: '熵/散度密度' } },
              x: { title: { display: true, text: 'x' } }
            },
            plugins: {
              title: { display: true, text: '熵与散度密度分解' }
            },
            animation: { duration: 0 }
          }
        });
      }

      function update() {
        const p_params = { mu: parseFloat(inputs.mu_p.value), sigma: parseFloat(inputs.sigma_p.value) };
        const q_params = { mu: parseFloat(inputs.mu_q.value), sigma: parseFloat(inputs.sigma_q.value) };
        
        values.mu_p_val.textContent = p_params.mu.toFixed(1);
        values.sigma_p_val.textContent = p_params.sigma.toFixed(1);
        values.mu_q_val.textContent = q_params.mu.toFixed(1);
        values.sigma_q_val.textContent = q_params.sigma.toFixed(1);
        
        const { H, Hpq, KL } = calcMetrics(p_params, q_params);
        drawCharts(p_params, q_params);
        
        document.getElementById('result').innerHTML =
          `<span class="math-formula">数据分布熵 <span class="math-italic">H</span>(<span class="math-italic">p</span>): <span class="highlight">${H.toFixed(4)}</span> nats</span><br>` +
          `<span class="math-formula">交叉熵 <span class="math-italic">H</span>(<span class="math-italic">p</span>, <span class="math-italic">q</span>): <span class="highlight">${Hpq.toFixed(4)}</span> nats</span><br>` +
          `<span class="math-formula">KL散度 <span class="math-italic">D</span><span class="math-subscript">KL</span>(<span class="math-italic">q</span>∥<span class="math-italic">p</span>): <span class="highlight">${KL.toFixed(4)}</span> nats</span>`;
      }
      
      Object.values(inputs).forEach(input => input.addEventListener('input', update));
      update();
    });
  </script>
</body>
</html>